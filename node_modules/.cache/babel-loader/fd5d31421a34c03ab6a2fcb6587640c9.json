{"ast":null,"code":"'use strict';\n\nconst utils = require('./utils');\n\nconst {\n  StripeError\n} = require('./Error');\n\nclass StreamProcessingError extends StripeError {} // Method for formatting HTTP body for the multipart/form-data specification\n// Mostly taken from Fermata.js\n// https://github.com/natevw/fermata/blob/5d9732a33d776ce925013a265935facd1626cc88/fermata.js#L315-L343\n\n\nconst multipartDataGenerator = (method, data, headers) => {\n  const segno = (Math.round(Math.random() * 1e16) + Math.round(Math.random() * 1e16)).toString();\n  headers['Content-Type'] = `multipart/form-data; boundary=${segno}`;\n  let buffer = Buffer.alloc(0);\n\n  function push(l) {\n    const prevBuffer = buffer;\n    const newBuffer = l instanceof Buffer ? l : Buffer.from(l);\n    buffer = Buffer.alloc(prevBuffer.length + newBuffer.length + 2);\n    prevBuffer.copy(buffer);\n    newBuffer.copy(buffer, prevBuffer.length);\n    buffer.write('\\r\\n', buffer.length - 2);\n  }\n\n  function q(s) {\n    return `\"${s.replace(/\"|\"/g, '%22').replace(/\\r\\n|\\r|\\n/g, ' ')}\"`;\n  }\n\n  const flattenedData = utils.flattenAndStringify(data);\n\n  for (const k in flattenedData) {\n    const v = flattenedData[k];\n    push(`--${segno}`);\n\n    if (v.hasOwnProperty('data')) {\n      push(`Content-Disposition: form-data; name=${q(k)}; filename=${q(v.name || 'blob')}`);\n      push(`Content-Type: ${v.type || 'application/octet-stream'}`);\n      push('');\n      push(v.data);\n    } else {\n      push(`Content-Disposition: form-data; name=${q(k)}`);\n      push('');\n      push(v);\n    }\n  }\n\n  push(`--${segno}--`);\n  return buffer;\n};\n\nconst streamProcessor = (method, data, headers, callback) => {\n  const bufferArray = [];\n  data.file.data.on('data', line => {\n    bufferArray.push(line);\n  }).once('end', () => {\n    const bufferData = Object.assign({}, data);\n    bufferData.file.data = Buffer.concat(bufferArray);\n    const buffer = multipartDataGenerator(method, bufferData, headers);\n    callback(null, buffer);\n  }).on('error', err => {\n    callback(new StreamProcessingError({\n      message: 'An error occurred while attempting to process the file for upload.',\n      detail: err\n    }), null);\n  });\n};\n\nconst multipartRequestDataProcessor = (method, data, headers, callback) => {\n  data = data || {};\n\n  if (method !== 'POST') {\n    return callback(null, utils.stringifyRequestData(data));\n  }\n\n  const isStream = utils.checkForStream(data);\n\n  if (isStream) {\n    return streamProcessor(method, data, headers, callback);\n  }\n\n  const buffer = multipartDataGenerator(method, data, headers);\n  return callback(null, buffer);\n};\n\nmodule.exports.multipartRequestDataProcessor = multipartRequestDataProcessor;","map":{"version":3,"names":["utils","require","StripeError","StreamProcessingError","multipartDataGenerator","method","data","headers","segno","Math","round","random","toString","buffer","Buffer","alloc","push","l","prevBuffer","newBuffer","from","length","copy","write","q","s","replace","flattenedData","flattenAndStringify","k","v","hasOwnProperty","name","type","streamProcessor","callback","bufferArray","file","on","line","once","bufferData","Object","assign","concat","err","message","detail","multipartRequestDataProcessor","stringifyRequestData","isStream","checkForStream","module","exports"],"sources":["/Users/joris/Library/Mobile Documents/com~apple~CloudDocs/OneDrive v1/34. Projects/stripe-prebuilt/node_modules/stripe/lib/multipart.js"],"sourcesContent":["'use strict';\n\nconst utils = require('./utils');\nconst {StripeError} = require('./Error');\n\nclass StreamProcessingError extends StripeError {}\n\n// Method for formatting HTTP body for the multipart/form-data specification\n// Mostly taken from Fermata.js\n// https://github.com/natevw/fermata/blob/5d9732a33d776ce925013a265935facd1626cc88/fermata.js#L315-L343\nconst multipartDataGenerator = (method, data, headers) => {\n  const segno = (\n    Math.round(Math.random() * 1e16) + Math.round(Math.random() * 1e16)\n  ).toString();\n  headers['Content-Type'] = `multipart/form-data; boundary=${segno}`;\n  let buffer = Buffer.alloc(0);\n\n  function push(l) {\n    const prevBuffer = buffer;\n    const newBuffer = l instanceof Buffer ? l : Buffer.from(l);\n    buffer = Buffer.alloc(prevBuffer.length + newBuffer.length + 2);\n    prevBuffer.copy(buffer);\n    newBuffer.copy(buffer, prevBuffer.length);\n    buffer.write('\\r\\n', buffer.length - 2);\n  }\n\n  function q(s) {\n    return `\"${s.replace(/\"|\"/g, '%22').replace(/\\r\\n|\\r|\\n/g, ' ')}\"`;\n  }\n\n  const flattenedData = utils.flattenAndStringify(data);\n\n  for (const k in flattenedData) {\n    const v = flattenedData[k];\n    push(`--${segno}`);\n    if (v.hasOwnProperty('data')) {\n      push(\n        `Content-Disposition: form-data; name=${q(k)}; filename=${q(\n          v.name || 'blob'\n        )}`\n      );\n      push(`Content-Type: ${v.type || 'application/octet-stream'}`);\n      push('');\n      push(v.data);\n    } else {\n      push(`Content-Disposition: form-data; name=${q(k)}`);\n      push('');\n      push(v);\n    }\n  }\n  push(`--${segno}--`);\n\n  return buffer;\n};\n\nconst streamProcessor = (method, data, headers, callback) => {\n  const bufferArray = [];\n  data.file.data\n    .on('data', (line) => {\n      bufferArray.push(line);\n    })\n    .once('end', () => {\n      const bufferData = Object.assign({}, data);\n      bufferData.file.data = Buffer.concat(bufferArray);\n      const buffer = multipartDataGenerator(method, bufferData, headers);\n      callback(null, buffer);\n    })\n    .on('error', (err) => {\n      callback(\n        new StreamProcessingError({\n          message:\n            'An error occurred while attempting to process the file for upload.',\n          detail: err,\n        }),\n        null\n      );\n    });\n};\n\nconst multipartRequestDataProcessor = (method, data, headers, callback) => {\n  data = data || {};\n\n  if (method !== 'POST') {\n    return callback(null, utils.stringifyRequestData(data));\n  }\n\n  const isStream = utils.checkForStream(data);\n  if (isStream) {\n    return streamProcessor(method, data, headers, callback);\n  }\n\n  const buffer = multipartDataGenerator(method, data, headers);\n  return callback(null, buffer);\n};\n\nmodule.exports.multipartRequestDataProcessor = multipartRequestDataProcessor;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}